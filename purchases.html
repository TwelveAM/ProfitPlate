<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ProfitPlate – Purchases</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta
      name="description"
      content="Manage your ingredients, categories, and supplier prices in ProfitPlate."
    />
    <link rel="stylesheet" href="assets/styles.css" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="assets/favicon-plate-32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="64x64"
      href="assets/favicon-plate-64.png"
    />
  </head>
  <body>
    <div class="page">
      <!-- Header with nav -->
      <header class="header">
  <div class="logo-block">
    <div class="logo-plate">
      <span>PP</span>
    </div>
    <div class="brand-text">
      <div class="name">ProfitPlate</div>
      <div class="tagline">Know your profit per plate.</div>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html" class="nav-link">Home</a>
    <a href="purchases.html" class="nav-link nav-link-active">Purchases</a>
    <a href="recipes.html" class="nav-link">Recipes</a>
    <a href="settings.html" class="nav-link">Settings</a>
  </nav>
</header>


      <main>
        <!-- Page title -->
        <section class="hero">
          <h1 class="hero-title">Purchases</h1>
          <p class="hero-subtitle">
            This is your ingredient base. Add items you buy, organize them by
            category, and keep supplier prices up to date. Recipes will use
            everything you add here.
          </p>
        </section>

        <!-- Primary actions -->
        <section class="hero-actions" style="margin-bottom: 16px;">
          <button
            class="btn-primary"
            type="button"
            id="add-item-toggle"
            onclick="toggleAddForm()"
          >
            Add item manually
          </button>
          <button class="btn-secondary" type="button">
            Upload invoice (AI, coming soon)
          </button>
        </section>

        <!-- Add item form (hidden by default) -->
        <section
          id="add-item-form"
          class="form-card"
          style="display: none; margin-bottom: 24px;"
        >
          <div class="form-title-row">
            <div class="form-title">Add a new purchase item</div>
            <div class="form-hint">
              Example: Butter 82% 1kg, Pancetta cubetti 1kg, Frozen fries 2.5kg.
            </div>
          </div>

          <form id="purchase-form">
            <div class="form-row">
              <div class="form-field" style="flex: 2;">
                <label class="form-label" for="item-name">Name</label>
                <input
                  class="form-input"
                  id="item-name"
                  name="name"
                  type="text"
                  placeholder="e.g. Salmon fillet 3.2kg"
                  required
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="item-supplier">Supplier</label>
                <input
                  class="form-input"
                  id="item-supplier"
                  name="supplier"
                  type="text"
                  placeholder="e.g. Metro, Carrefour"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label class="form-label" for="item-category">Category</label>
                <select
                  class="form-select"
                  id="item-category"
                  name="category"
                  required
                >
                  <option value="">Select...</option>
                  <option value="Meat & Fish">Meat &amp; Fish</option>
                  <option value="Dairy & Eggs">Dairy &amp; Eggs</option>
                  <option value="Vegetables & Fruit">
                    Vegetables &amp; Fruit
                  </option>
                  <option value="Dry Goods">Dry Goods</option>
                  <option value="Spices & Condiments">
                    Spices &amp; Condiments
                  </option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="form-field">
                <label class="form-label" for="item-subtype">Sub-type</label>
                <select
                  class="form-select"
                  id="item-subtype"
                  name="subtype"
                  disabled
                >
                  <option value="">Select category first</option>
                </select>
              </div>

              <div class="form-field">
                <label class="form-label" for="item-unit">Unit (for recipes)</label>
                <select
                  class="form-select"
                  id="item-unit"
                  name="unit"
                  required
                >
                  <option value="">Select...</option>
                  <option value="kg">kg</option>
                  <option value="g">gr</option>
                  <option value="l">L</option>
                  <option value="ml">ml</option>
                  <option value="pcs">pcs</option>
                  <option value="tray">tray</option>
                  <option value="bag">bag</option>
                  <option value="box">box</option>
                  <option value="other">other</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label class="form-label" for="item-price">
                  Purchase price (per recipe unit)
                </label>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input
                    class="form-input"
                    id="item-price"
                    name="price"
                    type="number"
                    min="0"
                    step="0.0001"
                    placeholder="e.g. 2.50"
                    required
                  />
                  <span style="font-size: 13px; color: #555;">€/unit</span>
                </div>

                <!-- Pack helper -->
                <div
                  style="
                    margin-top: 8px;
                    font-size: 12px;
                    color: #555;
                  "
                >
                  <div style="margin-bottom: 4px; font-weight: 600;">
                    Or use pack helper (optional)
                  </div>
                  <div
                    style="
                      display: flex;
                      flex-wrap: wrap;
                      gap: 6px;
                      align-items: center;
                    "
                  >
                    <input
                      class="form-input"
                      id="pack-qty"
                      type="number"
                      min="0"
                      step="0.01"
                      placeholder="e.g. 100"
                      style="max-width: 80px;"
                    />
                    <select
                      class="form-select"
                      id="pack-unit"
                      style="max-width: 90px;"
                    >
                      <option value="">unit</option>
                      <option value="g">gr</option>
                      <option value="kg">kg</option>
                      <option value="ml">ml</option>
                      <option value="l">L</option>
                      <option value="pcs">pcs</option>
                    </select>
                    <span>for</span>
                    <input
                      class="form-input"
                      id="pack-price"
                      type="number"
                      min="0"
                      step="0.01"
                      placeholder="e.g. 5"
                      style="max-width: 90px;"
                    />
                    <span>€</span>
                    <button
                      type="button"
                      class="btn-secondary"
                      onclick="fillPriceFromPack()"
                    >
                      Use pack
                    </button>
                  </div>
                  <div style="margin-top: 4px;">
                    <em style="font-size: 11px;"
                      >Example: 100 gr for 5 € → we calculate €/gr or €/kg
                      based on the recipe unit.</em
                    >
                  </div>
                </div>
              </div>

              <div class="form-field">
                <label class="form-label" for="item-notes">Notes (optional)</label>
                <input
                  class="form-input"
                  id="item-notes"
                  name="notes"
                  type="text"
                  placeholder="e.g. vacuum packed, brand, fat %"
                />
              </div>
            </div>

            <div class="form-footer">
              <button
                type="button"
                class="btn-ghost"
                onclick="document.getElementById('purchase-form').reset();"
              >
                Clear
              </button>
              <button type="submit" class="btn-primary">
                Save item (prototype)
              </button>
            </div>
          </form>
        </section>

        <!-- Category filters -->
        <section class="filter-section">
          <div class="filter-label">Categories</div>
          <div class="filter-row" id="category-row">
            <button
              class="btn-secondary filter-pill"
              data-category="Meat & Fish"
            >
              Meat &amp; Fish
            </button>
            <button
              class="btn-secondary filter-pill"
              data-category="Dairy & Eggs"
            >
              Dairy &amp; Eggs
            </button>
            <button
              class="btn-secondary filter-pill"
              data-category="Vegetables & Fruit"
            >
              Vegetables &amp; Fruit
            </button>
            <button class="btn-secondary filter-pill" data-category="Dry Goods">
              Dry Goods
            </button>
            <button
              class="btn-secondary filter-pill"
              data-category="Spices & Condiments"
            >
              Spices &amp; Condiments
            </button>
            <button class="btn-secondary filter-pill" data-category="Other">
              Other
            </button>
          </div>
        </section>

        <!-- Sub-type: appears only when a category with sub-types is selected -->
        <section
          class="filter-section"
          id="subtype-section"
          style="display: none;"
        >
          <div class="filter-label">Sub-type</div>
          <div class="filter-row" id="subtype-row"></div>
        </section>

        <!-- Recently updated -->
        <section style="margin-bottom: 18px;">
          <div
            style="
              font-size: 13px;
              margin-bottom: 6px;
              color: #555;
              font-weight: 600;
            "
          >
            Recently updated
          </div>
          <div class="features">
            <article class="feature-card">
              <div class="feature-title">Butter 82% – 6.40 €/kg</div>
              <p class="feature-text">Updated 2 hours ago • Dairy &amp; Eggs</p>
            </article>
            <article class="feature-card">
              <div class="feature-title">Pancetta cubetti – 10.20 €/kg</div>
              <p class="feature-text">
                Updated 3 days ago • Meat &amp; Fish (Smoked)
              </p>
            </article>
            <article class="feature-card">
              <div class="feature-title">Frozen fries – 4.20 €/2.5kg</div>
              <p class="feature-text">
                Updated 5 days ago • Vegetables &amp; Fruit (Frozen)
              </p>
            </article>
          </div>
        </section>

        <!-- Search + table placeholder -->
        <section>
          <div style="margin-bottom: 10px;">
            <input
              type="text"
              placeholder="Search by ingredient, supplier, or category..."
              style="
                width: 100%;
                padding: 10px 12px;
                border-radius: 999px;
                border: 1px solid #c3c7cf;
                font-size: 13px;
              "
            />
          </div>

          <div
            style="
              overflow-x: auto;
              border-radius: 12px;
              background: #ffffff;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            "
          >
            <table
              style="
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
              "
            >
              <thead>
                <tr
                  style="
                    text-align: left;
                    background: #f4f5f9;
                    border-bottom: 1px solid #e0e3ea;
                  "
                >
                  <th style="padding: 10px 12px;">Ingredient</th>
                  <th style="padding: 10px 12px;">Category</th>
                  <th style="padding: 10px 12px;">Sub-type</th>
                  <th style="padding: 10px 12px;">Unit</th>
                  <th style="padding: 10px 12px;">Latest price</th>
                  <th style="padding: 10px 12px;">Last updated</th>
                  <th style="padding: 10px 12px;">Actions</th>
                </tr>
              </thead>
              <tbody id="purchases-table-body">
  <!-- Rows will be rendered by JavaScript -->
</tbody>
            </table>
          </div>
        </section>
      </main>

      <div class="bottom-strip" style="margin-top: 22px;">
        This is a static prototype of the Purchases page. The form above does
        not store data yet — the next step is wiring it to real storage.
      </div>
    </div>
    
     <!-- Shared data store -->
    <script src="assets/app.js"></script>

    <!-- Tiny brain: filters + form helpers + pack helper -->
<script>
  // Category -> sub-types for filters AND form
  const categorySubtypes = {
    "Meat & Fish": ["Fresh", "Frozen", "Smoked", "Raw", "Cured", "Seafood"],
    "Dairy & Eggs": ["Milk / Cream", "Butter", "Cheese", "Eggs"],
    "Vegetables & Fruit": ["Fresh", "Frozen", "Dried", "Canned"],
    "Dry Goods": ["Pasta", "Flour", "Sugar", "Rice", "Legumes"],
    "Spices & Condiments": ["Spices", "Oils", "Vinegars", "Sauces"],
    Other: []
  };

  const categoryRow = document.getElementById("category-row");
  const subtypeSection = document.getElementById("subtype-section");
  const subtypeRow = document.getElementById("subtype-row");
  const addFormCategory = document.getElementById("item-category");
  const addFormSubtype = document.getElementById("item-subtype");
  const purchaseForm = document.getElementById("purchase-form");
  const addItemFormSection = document.getElementById("add-item-form");

  // Pack helper elements
  const unitSelect = document.getElementById("item-unit");
  const packQtyInput = document.getElementById("pack-qty");
  const packUnitSelect = document.getElementById("pack-unit");
  const packPriceInput = document.getElementById("pack-price");
  const priceInput = document.getElementById("item-price");

  let currentCategory = null;
  let addFormVisible = false;

  function renderSubtypes(categoryKey) {
    const subtypes = categorySubtypes[categoryKey] || [];

    if (!subtypes.length) {
      subtypeSection.style.display = "none";
      subtypeRow.innerHTML = "";
      return;
    }

    subtypeSection.style.display = "block";
    subtypeRow.innerHTML = "";

    subtypes.forEach((name) => {
      const btn = document.createElement("button");
      btn.className = "btn-secondary filter-pill";
      btn.textContent = name;
      btn.dataset.subtype = name;
      subtypeRow.appendChild(btn);
    });
  }

  // Category chips (toggle behaviour)
  categoryRow.addEventListener("click", (event) => {
    const btn = event.target.closest(".filter-pill");
    if (!btn) return;

    const categoryKey = btn.dataset.category;

    if (
      currentCategory === categoryKey &&
      subtypeSection.style.display === "block"
    ) {
      currentCategory = null;
      subtypeSection.style.display = "none";
      subtypeRow.innerHTML = "";
      categoryRow
        .querySelectorAll(".filter-pill")
        .forEach((b) => b.classList.remove("filter-pill-active"));
      return;
    }

    currentCategory = categoryKey;
    categoryRow
      .querySelectorAll(".filter-pill")
      .forEach((b) => b.classList.remove("filter-pill-active"));
    btn.classList.add("filter-pill-active");

    renderSubtypes(categoryKey);
  });

  // Toggle Add item form (no auto-scroll)
  function toggleAddForm() {
    addFormVisible = !addFormVisible;
    addItemFormSection.style.display = addFormVisible ? "block" : "none";
  }
  window.toggleAddForm = toggleAddForm;

  // Populate sub-type select in form when category changes
  addFormCategory.addEventListener("change", (e) => {
    const value = e.target.value;
    const subtypes = categorySubtypes[value] || [];
    addFormSubtype.innerHTML = "";

    if (!subtypes.length) {
      addFormSubtype.disabled = true;
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No sub-type";
      addFormSubtype.appendChild(opt);
      return;
    }

    addFormSubtype.disabled = false;
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Select...";
    addFormSubtype.appendChild(placeholder);

    subtypes.forEach((st) => {
      const opt = document.createElement("option");
      opt.value = st;
      opt.textContent = st;
      addFormSubtype.appendChild(opt);
    });
  });

  // --- Pack helper logic ---

  function normalizeUnit(u) {
    if (!u) return "";
    u = u.toLowerCase();
    if (u === "gr") u = "g";
    return u;
  }

  function convertToBase(qty, from, to) {
    let q = Number(qty) || 0;
    from = normalizeUnit(from);
    to = normalizeUnit(to);

    if (!from || !to) return 0;
    if (from === to) return q;

    // g <-> kg
    if (from === "g" && to === "kg") return q / 1000;
    if (from === "kg" && to === "g") return q * 1000;

    // ml <-> l
    if (from === "ml" && to === "l") return q / 1000;
    if (from === "l" && to === "ml") return q * 1000;

    // pcs or other: no conversion, assume same thing
    return q;
  }

  function fillPriceFromPack() {
    const baseUnit = unitSelect.value;
    const packQtyRaw = packQtyInput.value || "0";
    const packPriceRaw = packPriceInput.value || "0";
    const packUnit = packUnitSelect.value;

    const packQty = parseFloat(packQtyRaw.replace(",", "."));
    const packPrice = parseFloat(packPriceRaw.replace(",", "."));

    if (!baseUnit || !packUnit || !packQty || !packPrice || packQty <= 0) {
      alert("Fill pack quantity, unit, and price first.");
      return;
    }

    const qtyInBase = convertToBase(packQty, packUnit, baseUnit);

    if (!qtyInBase || qtyInBase <= 0) {
      alert(
        "Could not convert pack unit to recipe unit. Use compatible units (g/kg or ml/L)."
      );
      return;
    }

    const perUnit = packPrice / qtyInBase;
    priceInput.value = perUnit.toFixed(4);
  }
  window.fillPriceFromPack = fillPriceFromPack;

  // === REAL SUBMIT: save to ppData.purchases ===
  purchaseForm.addEventListener("submit", (e) => {
    e.preventDefault();

    if (!window.ppData) {
      window.ppData = { purchases: [], recipes: [], settings: {} };
    }

    const name = document.getElementById("item-name").value.trim();
    const supplier = document.getElementById("item-supplier").value.trim();
    const category = document.getElementById("item-category").value;
    const subtype = document.getElementById("item-subtype").value || "";
    const unit = document.getElementById("item-unit").value;
    const notes = document.getElementById("item-notes").value.trim();

    const priceRaw = document.getElementById("item-price").value || "0";
    const price = parseFloat(priceRaw.replace(",", "."));

    if (!name || !category || !unit || isNaN(price) || price <= 0) {
      alert("Name, category, unit and price are required.");
      return;
    }

    const item = {
      id: "pur_" + Date.now(),
      name,
      supplier,
      category,
      subtype,
      unit,
      pricePerUnit: price,
      currency:
        (window.ppData.settings && window.ppData.settings.currency) || "EUR",
      notes,
      updatedAt: new Date().toISOString()
    };

    if (!Array.isArray(window.ppData.purchases)) {
      window.ppData.purchases = [];
    }

    window.ppData.purchases.push(item);

    if (typeof saveData === "function") {
      saveData(window.ppData);
    }

    alert("Item saved locally. It will be available in Recipes.");

    // reset form + pack helper
    purchaseForm.reset();
    packQtyInput.value = "";
    packUnitSelect.value = "";
    packPriceInput.value = "";
  });
</script>
</body>
</html>
